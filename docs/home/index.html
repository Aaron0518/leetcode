<!DOCTYPE HTML>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>使用BlueZ用C语言开发蓝牙程序</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="alternate" type="application/rss+xml" title="Jekyll • Simple, blog-aware, static sites - Feed" href="/feed.xml" />
  <link rel="alternate" type="application/atom+xml" title="Recent commits to Jekyll’s master branch" href="https://github.com/mojombo/jekyll/commits/master.atom" />
  <link href='http://fonts.googleapis.com/css?family=Lato:100,300,400,700,900,100italic,300italic,400italic,700italic,900italic' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Arizonia' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/css/normalize.css" />
  <link rel="stylesheet" href="/css/gridism.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link rel="stylesheet" href="/css/pygments.css" />
  <link rel="icon" type="image/x-icon" href="/favicon.png" />
  <script src="/js/modernizr-2.5.3.min.js"></script>
</head>


<body class="wrap">
  <header>
  <nav class="mobile-nav show-on-mobiles">
    <ul>
  <li class="">
  <a href="/">首页</a>
  </li>
  <li class="">
  <a href="/questions/home">题库</a>
  </li>
  <li class="current">            
  <a href="/docs/home">文档</a>                              
  </li>
  <li class="">
  <a href="/news">新闻</a>
  </li>
  <li class="">
    <a href="https://github.com/xiangzhai/leetcode">GitHub</a>
  </li>
</ul>

  </nav>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <h1>
        <a href="/">
          <span>LeetCode中文</span>
          <img src="/img/logo-2x.png" width="500px" height="115px" alt="">
        </a>
      </h1>
    </div>
    <nav class="main-nav unit two-thirds hide-on-mobiles">
      <ul>
  <li class="">
  <a href="/">首页</a>
  </li>
  <li class="">
  <a href="/questions/home">题库</a>
  </li>
  <li class="current">            
  <a href="/docs/home">文档</a>                              
  </li>
  <li class="">
  <a href="/news">新闻</a>
  </li>
  <li class="">
    <a href="https://github.com/xiangzhai/leetcode">GitHub</a>
  </li>
</ul>

    </nav>
  </div>
</header>


    <section class="docs">
    <div class="grid">

      <div class="docs-nav-mobile unit whole show-on-mobiles">
  <select onchange="if (this.value) window.location.href=this.value">
    <option value="">Navigate the docs…</option>
    <optgroup label="Getting started">
      <option value="/docs/home">Welcome</option>
      <option value="/docs/quickstart">Quick-start guide</option>
      <option value="/docs/installation">Installation</option>
      <option value="/docs/usage">Basic Usage</option>
      <option value="/docs/structure">Directory structure</option>
      <option value="/docs/configuration">Configuration</option>
    </optgroup>
    <optgroup label="Your Content">
      <option value="/docs/frontmatter">Front-matter</option>
      <option value="/docs/posts">Writing posts</option>
      <option value="/docs/drafts">Working with drafts</option>
      <option value="/docs/pages">Creating pages</option>
      <option value="/docs/variables">Variables</option>
      <option value="/docs/migrations">Blog migrations</option>
    </optgroup>
    <optgroup label="Customization">
      <option value="/docs/templates">Templates</option>
      <option value="/docs/permalinks">Permalinks</option>
      <option value="/docs/pagination">Pagination</option>
      <option value="/docs/plugins">Plugins</option>
      <option value="/docs/extras">Extras</option>
    </optgroup>
    <optgroup label="Deployment">
      <option value="/docs/github-pages">GitHub Pages</option>
      <option value="/docs/deployment-methods">Other methods</option>
    </optgroup>
    <optgroup label="Miscellaneous">
      <option value="/docs/troubleshooting">Troubleshooting</option>
      <option value="/docs/sites">Sites using Jekyll</option>
      <option value="/docs/resources">Resources</option>
      <option value="/docs/upgrading">Upgrading</option>
    </optgroup>
    <optgroup label="Meta">
      <option value="/docs/contributing">Contributing</option>
      <option value="/docs/history">History</option>
    </optgroup>
  </select>
</div>


      <div class="unit four-fifths">
        <article>
          <h1>使用BlueZ用C语言开发蓝牙程序</h1>
          <h2>选择一个通讯搭档</h2>

<p>一个简单的程序——识别附近的蓝牙设备。程序获取系统蓝牙资源，扫描附近的蓝牙设备
，然后查看设备的名称。</p>

<p>simplescan.c</p>
<div class="highlight"><pre><code class="c"><span class="cp">#include &lt;stdio.h&gt;</span>
<span class="cp">#include &lt;stdlib.h&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;sys/socket.h&gt;</span>
<span class="cp">#include &lt;bluetooth/bluetooth.h&gt;</span>
<span class="cp">#include &lt;bluetooth/hci.h&gt;</span>
<span class="cp">#include &lt;bluetooth/hci_lib.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
    <span class="n">inquiry_info</span> <span class="o">*</span><span class="n">ii</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">max_rsp</span><span class="p">,</span> <span class="n">num_rsp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">dev_id</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">addr</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">248</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="n">dev_id</span> <span class="o">=</span> <span class="n">hci_get_route</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">hci_open_dev</span><span class="p">(</span><span class="n">dev_id</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dev_id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sock</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;opening socket&quot;</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">max_rsp</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
    <span class="n">flags</span> <span class="o">=</span> <span class="n">IREQ_CACHE_FLUSH</span><span class="p">;</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="p">(</span><span class="n">inquiry_info</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">max_rsp</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inquiry_info</span><span class="p">));</span>
    
    <span class="n">num_rsp</span> <span class="o">=</span> <span class="n">hci_inquiry</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">max_rsp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ii</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_rsp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
        <span class="n">perror</span><span class="p">(</span><span class="s">&quot;hci_inquiry&quot;</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_rsp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ba2str</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">hci_read_remote_name</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bdaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> 
            <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;[unknown]&quot;</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">ii</span><span class="p">);</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>


<h3>用scons编译</h3>

<div class="highlight"><pre><code class="python"><span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">CCFLAGS</span><span class="o">=</span><span class="s">&#39;-g&#39;</span><span class="p">)</span>                                                 
<span class="n">env</span><span class="o">.</span><span class="n">ParseConfig</span><span class="p">(</span><span class="s">&#39;pkg-config --cflags --libs bluez&#39;</span><span class="p">)</span>                             
                                                                                
<span class="n">env</span><span class="o">.</span><span class="n">Program</span><span class="p">(</span><span class="s">&#39;simplescan.c&#39;</span><span class="p">)</span>
</code></pre>
</div>


<p>$ scons</p>

<h3>解释</h3>

<div class="highlight"><pre><code class="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">b</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="kt">bdaddr_t</span><span class="p">;</span>
</code></pre>
</div>


<p>用来表示一个蓝牙设备地址的基本数据结构是bdaddr_t。所有BlueZ的蓝牙地址都存储
在bdaddr_t结构体中。BlueZ提供两个函数用来字符与bdaddr_t结构体的互相转换。</p>

<div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">str2ba</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">bdaddr_t</span> <span class="o">*</span><span class="n">ba</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">ba2str</span><span class="p">(</span><span class="k">const</span> <span class="kt">bdaddr_t</span> <span class="o">*</span><span class="n">ba</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">);</span>
</code></pre>
</div>


<p>str2ba将XX:XX:XX:XX:XX:XX格式的字符串转换成6字节的bdaddr_t，其中XX是十六进制
数，代表48位地址的8位。ba2str实现相反的功能。</p>

<p>本地蓝牙适配器用0开始的数字标识，当分配系统资源时，一个程序必须指定是哪一个
适配器在使用。通常的，只有一个适配器或者无所谓哪一个在用，所以传递NULL指针给
hci_get_route将获得第一个可使用的蓝牙适配器的资源。</p>

<div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="nf">hci_get_route</span><span class="p">(</span><span class="kt">bdaddr_t</span> <span class="o">*</span><span class="n">bdaddr</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">hci_open_dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_id</span><span class="p">);</span>
</code></pre>
</div>


Note    

<p>把设备号写死0不好，因为第一个适配器不一定id是0。比如，如果系统有两个适配器，
而且第一个适配器（id 0）禁用了，那么第一个可使用的适配器的id就是1。</p>

<p>如果当前有多个蓝牙适配器，选择地址为01:23:45:67:89:AB的适配器，传递char *
指针地址给hci_devid，在hci_get_route中使用它的返回值。</p>

<div class="highlight"><pre><code class="c"><span class="kt">int</span> <span class="n">dev_id</span> <span class="o">=</span> <span class="n">hci_devid</span><span class="p">(</span><span class="s">&quot;01:23:45:67:89:AB&quot;</span><span class="p">);</span>
</code></pre>
</div>


Most Bluetooth operations require the use of an open socket. hci_open_dev is a convenience function that opens a Bluetooth socket with the specified resource number [2]. To be clear, the socket opened by hci_open_dev represents a connection to the microcontroller on the specified local Bluetooth adapter, and not a connection to a remote Bluetooth device. Performing low level Bluetooth operations involves sending commands directly to the microcontroller with this socket, and Section 4.5 discusses this in greater detail.

After choosing the local Bluetooth adapter to use and allocating system resources, the program is ready to scan for nearby Bluetooth devices. In the example, hci_inquiry performs a Bluetooth device discovery and returns a list of detected devices and some basic information about them in the variable ii. On error, it returns -1 and sets errno accordingly.

<div class="highlight"><pre><code class="c"><span class="lineno">1</span> <span class="kt">int</span> <span class="nf">hci_inquiry</span><span class="p">(</span><span class="kt">int</span> <span class="n">dev_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">max_rsp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">lap</span><span class="p">,</span> 
<span class="lineno">2</span>                 <span class="n">inquiry_info</span> <span class="o">**</span><span class="n">ii</span><span class="p">,</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">);</span>
</code></pre>
</div>


hci_inquiry is one of the few functions that requires the use of a resource number instead of an open socket, so we use the dev_id returned by hci_get_route. The inquiry lasts for at most 1.28 * len seconds, and at most max_rsp devices will be returned in the output parameter ii, which must be large enough to accommodate max_rsp results. We suggest using a max_rsp of 255 for a standard 10.24 second inquiry.

If flags is set to IREQ_CACHE_FLUSH, then the cache of previously detected devices is flushed before performing the current inquiry. Otherwise, if flags is set to 0, then the results of previous inquiries may be returned, even if the devices aren't in range anymore.

The inquiry_info structure is defined as

<div class="highlight"><pre><code class="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="kt">bdaddr_t</span>    <span class="n">bdaddr</span><span class="p">;</span>
    <span class="kt">uint8_t</span>     <span class="n">pscan_rep_mode</span><span class="p">;</span>
    <span class="kt">uint8_t</span>     <span class="n">pscan_period_mode</span><span class="p">;</span>
    <span class="kt">uint8_t</span>     <span class="n">pscan_mode</span><span class="p">;</span>
    <span class="kt">uint8_t</span>     <span class="n">dev_class</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
    <span class="kt">uint16_t</span>    <span class="n">clock_offset</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">packed</span><span class="p">))</span> <span class="n">inquiry_info</span><span class="p">;</span>
</code></pre>
</div>


For the most part, only the first entry - the bdaddr field, which gives the address of the detected device - is of any use. Occasionally, there may be a use for the dev_class field, which gives information about the type of device detected (i.e. if it's a printer, phone, desktop computer, etc.) and is described in the Bluetooth Assigned Numbers [3]. The rest of the fields are used for low level communication, and are not useful for most purposes. The interested reader can see the Bluetooth Core Specification [4] for more details.

Once a list of nearby Bluetooth devices and their addresses has been found, the program determines the user-friendly names associated with those addresses and presents them to the user. The hci_read_remote_name function is used for this purpose.

<div class="highlight"><pre><code class="c"><span class="lineno">1</span> <span class="kt">int</span> <span class="n">hci_read_remote_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">sock</span><span class="p">,</span> <span class="k">const</span> <span class="kt">bdaddr_t</span> <span class="o">*</span><span class="n">ba</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> 
<span class="lineno">2</span>                          <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
</code></pre>
</div>


hci_read_remote_name tries for at most timeout milliseconds to use the socket sock to query the user-friendly name of the device with Bluetooth address ba. On success, hci_read_remote_name returns 0 and copies at most the first len bytes of the device's user-friendly name into name. On failure, it returns -1 and sets errno accordingly.
Notes
[1] 

http://www.bluez.org/lists.html
[2] 

for the curious, it makes a call to socket(AF_BLUETOOTH, SOCK_RAW, BTPROTO_HCI), followed by a call to bind with the specified resource number.
[3] 

https://www.bluetooth.org/foundry/assignnumb/document/baseband
[4] 

http://www.bluetooth.org/spec

          <div class="section-nav">
  <div class="left align-right">
    
      <span class="prev disabled">返回</span>
    
  </div>
  <div class="right align-left">
    
    <a href="/docs/quickstart" class="next">
        下一个
      </a>
    
  </div>
  <div class="clear"></div>
</div>


        </article>
      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    <h4>Getting Started</h4>
    <ul>
      <li class="">
        <a href="/docs/home">Welcome</a>
      </li>
      <li class="">
        <a href="/docs/quickstart">Quick-start guide</a>
      </li>
      <li class="">
        <a href="/docs/installation">Installation</a>
      </li>
      <li class="">
        <a href="/docs/usage">Basic Usage</a>
      </li>
      <li class="">
        <a href="/docs/structure">Directory structure</a>
      </li>
      <li class="">
        <a href="/docs/configuration">Configuration</a>
      </li>
    </ul>
    <h4>Your Content</h4>
    <ul>
      <li class="">
        <a href="/docs/frontmatter">Front-matter</a>
      </li>
      <li class="">
        <a href="/docs/posts">Writing posts</a>
      </li>
      <li class="">
        <a href="/docs/drafts">Working with drafts</a>
      </li>
      <li class="">
        <a href="/docs/pages">Creating pages</a>
      </li>
      <li class="">
        <a href="/docs/variables">Variables</a>
      </li>
      <li class="">
        <a href="/docs/migrations">Blog migrations</a>
      </li>
    </ul>
    <h4>Customization</h4>
    <ul>
      <li class="">
        <a href="/docs/templates">Templates</a>
      </li>
      <li class="">
        <a href="/docs/permalinks">Permalinks</a>
      </li>
      <li class="">
        <a href="/docs/pagination">Pagination</a>
      </li>
      <li class="">
        <a href="/docs/plugins">Plugins</a>
      </li>
      <li class="">
        <a href="/docs/extras">Extras</a>
      </li>
    </ul>
    <h4>Deployment</h4>
    <ul>
      <li class="">
        <a href="/docs/github-pages">GitHub Pages</a>
      </li>
      <li class="">
        <a href="/docs/deployment-methods">Other methods</a>
      </li>
    </ul>
    <h4>Miscellaneous</h4>
    <ul>
      <li class="">
        <a href="/docs/troubleshooting">Troubleshooting</a>
      </li>
      <li class="">
        <a href="/docs/sites">Sites using Jekyll</a>
      </li>
      <li class="">
        <a href="/docs/resources">Resources</a>
      </li>
      <li class="">
        <a href="/docs/upgrading">Upgrading</a>
      </li>
    </ul>
    <h4>Meta</h4>
    <ul>
      <li class="">
        <a href="/docs/contributing">Contributing</a>
      </li>
      <li class="">
        <a href="/docs/history">History</a>
      </li>
    </ul>
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <p>Copyright 2013 (C) <a href="mailto:xiangzhai83@gmail.com?subject=LeetCode中文">Zhai Xiang</a></p>
    </div>
    <div class="unit two-thirds align-right center-on-mobiles">
      <p>所有题库、答案、源代码遵循GPL V3 请轻轻地注明出处地转载</p>
    </div>
  </div>
</footer>

  
  <!-- Gauges (http://gaug.es/) -->
  <script type="text/javascript">
    var _gauges = _gauges || [];
    (function() {
      var t   = document.createElement('script');
      t.type  = 'text/javascript';
      t.async = true;
      t.id    = 'gauges-tracker';
      t.setAttribute('data-site-id', '503c5af6613f5d0f19000027');
      t.src = '//secure.gaug.es/track.js';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(t, s);
    })();
  </script>





</body>
</html>
